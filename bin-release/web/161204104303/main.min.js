var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.width=480,this.textField.height=100,this.textField.textAlign="center",this.textField.x=328,this.textField.y=270},s.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.counter=0,this.movieTotalFrame=0,this.movieIndex=0,this.isPlaying=!1,this.isResourceReady=!1,this.movieKeyList=["preload","3","4","5","6","preload","3","4","5","6"],this.resourceMapList={},this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(e){console.log(e.groupName),"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.addResource("preload"),this.createGameScene())},s.playReadomMovie=function(){var e=Math.floor(10*Math.random()),t="preload";e<this.movieKeyList.length&&(t=this.movieKeyList[e]),this.resourceMapList[t]?this.addResource(t):(this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceReloadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup(t))},s.onResourceReloadComplete=function(e){console.log(e.groupName),this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceReloadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.addResource(e.groupName)},s.addResource=function(e){if(this.resourceMapList[e])this.resourceTextureList=this.resourceMapList[e];else{var t=RES.getGroupByName(e);this.resourceTextureList=[];for(var i=0,s=t;i<s.length;i++){var r=s[i];this.resourceTextureList.push(RES.getRes(r.name))}this.movieTotalFrame=this.resourceTextureList.length,this.resourceMapList[e]=this.resourceTextureList}this.openReady()},s.createGameScene=function(){var e=this.createBitmapByName("2_36");this.addChild(e),this.stageW=this.stage.stageWidth,this.stageH=this.stage.stageHeight,e.width=this.stageW,e.height=this.stageH,this.moviePlayer=new egret.Bitmap,this.stage.addChild(this.moviePlayer);var t=new egret.TextField;this.stage.addChild(t),t.size=12,t.text="上一页",t.width=120,t.height=20,t.touchEnabled=!0,t.x=20,t.y=this.stageH-t.height>>1,t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPreviewClick,this);var i=new egret.TextField;this.stage.addChild(i),i.size=12,i.text="下一页",i.width=120,i.height=20,i.touchEnabled=!0,i.x=this.stageW-i.width-20,i.y=this.stageH-t.height>>1,i.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onNextClick,this),this.stage.addEventListener(egret.Event.ENTER_FRAME,this.onStageUpdate,this),this.openPlaying()},s.onPreviewClick=function(e){this.isPlaying||(this.openPlaying(),this.playReadomMovie())},s.onNextClick=function(e){this.isPlaying||(this.openPlaying(),this.playReadomMovie())},s.openPlaying=function(){this.isPlaying=!0},s.closePlaying=function(){this.isPlaying=!1},s.openReady=function(){this.isResourceReady=!0},s.closeReady=function(){this.isResourceReady=!1},s.onStageUpdate=function(e){this.counter++,this.counter%5==0&&this.updateFrame()},s.updateFrame=function(){this.isPlaying&&this.isResourceReady&&(this.moviePlayer.texture=this.resourceTextureList[this.movieIndex],this.moviePlayer.width=this.stageW,this.moviePlayer.height=this.stageH,0==this.movieIndex&&console.log("开始播放.."),this.movieIndex++,this.movieIndex>=this.movieTotalFrame&&(this.movieIndex=0,console.log("最后一帧.."),this.closePlaying()))},s.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},s.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},s.onResourceProgress=function(e){this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},s.createBitmapByName=function(e){var t=new egret.Bitmap,i=RES.getRes(e);return t.texture=i,t},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var MoveClipSpriteSheet=function(e){function t(t,i){e.call(this),this.currFrame=0,this.frameW=0,this.frameH=0,this.movieCurrentTime=0,this.textureName=t,this.framefNum=i,this.init()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.init=function(){var e=RES.getRes(this.textureName);this.spriteSheet=new egret.SpriteSheet(e),this.frameW=e._bitmapWidth/this.framefNum,this.frameH=e._bitmapHeight,this.anchorOffsetX=this.frameW/2,this.anchorOffsetY=this.frameH/2,this.draw()},s.draw=function(){var e=this.textureName+this.currFrame;this.texture=this.spriteSheet.getTexture(e),this.texture||(this.texture=this.spriteSheet.createTexture(e,this.frameW*this.currFrame,0,this.frameW,this.frameH))},s.render=function(e){this.movieCurrentTime+=e;var t=Math.floor(this.movieCurrentTime/120);t!=this.currFrame&&(this.currFrame=t,this.currFrame>=this.framefNum&&(this.currFrame=0,this.movieCurrentTime=0),this.draw())},t}(egret.Bitmap);egret.registerClass(MoveClipSpriteSheet,"MoveClipSpriteSheet");